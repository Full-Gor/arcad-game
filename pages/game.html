<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guerre-galactique</title>
    <style>
        /* Styles de base */
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }

        /* Canvas du jeu */
        #gameCanvas {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Interface utilisateur */
        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            z-index: 10;
        }

        #coinsCount {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            z-index: 10;
        }

        /* Conteneur vidéo */
        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        #powerUpVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Écrans de fin de jeu */
        #gameOverContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.9);
            color: red;
            font-family: Arial, sans-serif;
        }

        #continueCounter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            text-align: center;
        }

        #gameOverMessage {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            color: red;
            padding: 50px;
            font-size: 100px;
            border: 5px solid red;
            z-index: 2001;
            text-align: center;
        }

        .player-stats {
            position: fixed;
            right: 20px;
            top: 60px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            z-index: 10;
        }

        .player-stats-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .player1-stats {
            background: rgba(4, 251, 172, 0.2);
        }

        .player2-stats {
            background: rgba(255, 127, 80, 0.2);
        }

        .player3-stats {
            background: rgba(255, 255, 80, 0.2);
        }

        /* Style pour l'indicateur de vie du boss */
        #bossHealthBar {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid red;
            display: none;
            z-index: 10;
        }

        #bossHealthFill {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff6600);
            width: 100%;
            transition: width 0.3s;
        }

        @keyframes rotateBackground {
            from { background-position: 0 0; }
            to { background-position: 100% 0; }
        }

        .scrolling-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/img/back1.png') repeat-x;
            background-size: auto 100%;
            z-index: -1;
            animation: rotateBackground 60s linear infinite;
        }

        @keyframes shieldPulse {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 0.8;
                box-shadow: 0 0 15px currentColor;
            }
            50% {
                transform: scale(1.1) rotate(180deg);
                opacity: 0.6;
                box-shadow: 0 0 25px currentColor;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 0.8;
                box-shadow: 0 0 15px currentColor;
            }
        }

        .shield-effect {
            animation: shieldPulse 2s infinite linear;
            border: 3px solid currentColor;
            border-radius: 50%;
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Interface utilisateur -->
    <span id="coinsCount">0</span>
    <div class="stats">
        Vies: <span id="livesCount">3</span><br>
        Ennemis tués: <span id="enemiesKilledCount">0</span>
    </div>

    <!-- Fond d'écran défilant -->
    <div id="scrollingBackground" class="scrolling-background" style="display: none;"></div>
   
    <!-- Barre de vie du boss -->
    <div id="bossHealthBar">
        <div id="bossHealthFill"></div>
    </div>

    <div class="player-mode" id="playerModeIndicator" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; color: #04fbac; z-index: 10;">Mode 1 joueur</div>
    <div id="playerStats" class="player-stats" style="display: none;">
        <div id="player1Stats" class="player-stats-item player1-stats">
            Player 1: <span id="p1Lives">3</span> vies |
            Points: <span id="p1Points">0</span> |
            Kills: <span id="p1Kills">0</span>
        </div>
        <div id="player2Stats" class="player-stats-item player2-stats">
            Player 2: <span id="p2Lives">3</span> vies |
            Points: <span id="p2Points">0</span> |
            Kills: <span id="p2Kills">0</span>
        </div>
        <div id="player3Stats" class="player-stats-item player3-stats">
            Player 3: <span id="p3Lives">3</span> vies |
            Points: <span id="p3Points">0</span> |
            Kills: <span id="p3Kills">0</span>
        </div>
    </div>

    <!-- Canvas du jeu -->
    <canvas id="gameCanvas"></canvas>

    <!-- Conteneur vidéo pour les power-ups -->
    <div id="videoContainer">
        <video id="powerUpVideo" src="video/tirePlasma.mp4"></video>
    </div>

    <!-- Conteneurs pour le game over -->
    <div id="gameOverContainer">
        <div id="continueCounter"></div>
    </div>
    <div id="gameOverMessage">GAME OVER</div>

    <script>
        // Configuration initiale
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Récupération des paramètres de difficulté
        const enemySpeedMultiplier = parseFloat(localStorage.getItem('enemySpeed')) || 1;
        const enemyBulletSpeedMultiplier = parseFloat(localStorage.getItem('enemyBulletSpeed')) || 3;
        const powerUpFrequency = parseInt(localStorage.getItem('powerUpFrequency')) || 5;
        const livesFrequency = parseInt(localStorage.getItem('livesFrequency')) || 5;

        // Variables globales
        let gameIsRunning = true;
        let lastFrameTime = 0;
        let deltaTime = 0;
        let fpsCounter = 0;
        let fpsTimer = 0;
        const fpsLimit = 60;
        const frameDuration = 1000 / fpsLimit;

        // Variables de jeu
        let shooting = false;
        let enemies = [];
        let enemyBullets = [];
        let enemiesKilled = 0;
        let playerLives = 3;
        let simultaneousKills = 0;
        let killTimer = null;
        let redPoints = [];
        let coins = 0;
        let killsWithoutDeath = 0;
        let lastKillTime = Date.now();
        let lastEnemyCount = 0;
        let powerUpTimeoutId = null;

        // Boss configuration
        let bossActive = false;
        let boss = null;
        const bossImg = new Image();
        bossImg.src = "/img/boss.jpg";
        let bossHealth = 500; // Augmenté à 500
        let bossRotation = 0;
        let bossShootTimer = 0;
        let bossHitEffect = false;
        let bossHitEffectTimer = 0;
        let backgroundActive = false;

        // Configuration multijoueur
        const urlParams = new URLSearchParams(window.location.search);
        const playersCount = urlParams.get('players') || '1';
        const isMultiplayer = playersCount !== '1';
        const isTriplePlayer = playersCount === '3';

        // Mise à jour de l'indicateur de mode
        document.getElementById('playerModeIndicator').textContent =
            isTriplePlayer ? 'Mode 3 joueurs' :
            (isMultiplayer ? 'Mode 2 joueurs' : 'Mode 1 joueur');

        // Configuration des vaisseaux
        const starship = {
            x: canvas.width / 2,
            y: canvas.height - 50,
            width: 50,
            height: 50,
            bullets: [],
            powerUpLevel: 0,
            player: 1,
            powerUpTimeoutId: null,
            lives: 3,
            isActive: true,
            stunned: false,
            stunnedTimeout: null,
            redPointsCollected: 0,
            shield: false,
            shieldTimeout: null
        };

        const starship2 = isMultiplayer ? {
            x: canvas.width / 2 + 100,
            y: canvas.height - 50,
            width: 50,
            height: 50,
            bullets: [],
            powerUpLevel: 0,
            player: 2,
            powerUpTimeoutId: null,
            lives: 3,
            isActive: true,
            stunned: false,
            stunnedTimeout: null,
            redPointsCollected: 0,
            shield: false,
            shieldTimeout: null
        } : null;

        const starship3 = isTriplePlayer ? {
            x: canvas.width / 2 - 100,
            y: canvas.height - 50,
            width: 50,
            height: 50,
            bullets: [],
            powerUpLevel: 0,
            player: 3,
            powerUpTimeoutId: null,
            lives: 3,
            isActive: true,
            stunned: false,
            stunnedTimeout: null,
            redPointsCollected: 0,
            shield: false,
            shieldTimeout: null
        } : null;

        // Variables de contrôle
        let keyUp = false, keyDown = false, keyLeft = false, keyRight = false, keySpace = false;
        let keyW = false, keyS = false, keyA = false, keyD = false, keyE = false;
        let shooting2 = false;
        let shooting3 = false;
        let gamepadConnected = false;
        let gamepadIndex = null;
        let shipRotation = 0;
        const maxRotation = 20;
        const rotationSpeed = 0.5;
        let lastShipX = canvas.width/2;

        // Chargement des sons
        const soundEffects = {
            shoot: new Audio("/audio/tire1.mp3"),
            hit: new Audio("/audio/hit.mp3"),
            coin: new Audio("/audio/coin.mp3"),
            king: new Audio("/audio/king.mp3"),
            perfect: new Audio("/audio/perfect.mp3"),
            doubleKill: new Audio("/audio/doubleKill.mp3"),
            tripleKill: new Audio("/audio/tripleKill.mp3"),
            humiliation: new Audio("/audio/humiliation.mp3"),
            brutal: new Audio("/audio/brutal.mp3"),
            super: new Audio("/audio/super.mp3"),
            master: new Audio("/audio/master.mp3"),
            awesome: new Audio("/audio/awesome.mp3"),
            bossAppear: new Audio("/audio/king.mp3"),
            bossHit: new Audio("/audio/hit.mp3"),
            bossDeath: new Audio("/audio/awesome.mp3")
        };

        // Configuration des volumes
        const volumes = {
            shoot: 0.3,
            hit: 1.0,
            coin: 0.4,
            king: 0.7,
            perfect: 1.0,
            doubleKill: 0.7,
            tripleKill: 0.5,
            humiliation: 1.0,
            brutal: 1.0,
            super: 1.0,
            master: 1.0,
            awesome: 1.0,
            bossAppear: 1.0,
            bossHit: 0.5,
            bossDeath: 1.0
        };

        Object.keys(soundEffects).forEach(key => {
            soundEffects[key].volume = volumes[key] || 1.0;
        });

        // Chargement des images
        const starshipImg = new Image();
        const starship2Img = isMultiplayer ? new Image() : null;
        const starship3Img = isTriplePlayer ? new Image() : null;
        const bulletImg = new Image();
        const backgroundImg = new Image();
        backgroundImg.src = "/img/back1.png";
        const enemyImgs = Array(6).fill().map(() => new Image());
        const enemyBulletImgs = Array(3).fill().map(() => new Image());
        const livesImg = new Image();
        const powerUpImgs = Array(3).fill().map(() => new Image());

        // Configuration des chemins d'images
        starshipImg.src = getSelectedShip();
        if (isMultiplayer && starship2Img) starship2Img.src = getSelectedShipP2();
        if (isTriplePlayer && starship3Img) starship3Img.src = getSelectedShipP3();
        bulletImg.src = "/img/bullets1.jpg";
        enemyImgs.forEach((img, i) => img.src = `/img/enemy${i ? i + 1 : ""}.jpg`);
        enemyBulletImgs.forEach((img, i) => img.src = `/img/bullets${i + 2}.jpg`);
        livesImg.src = "/img/lives.jpg";
        powerUpImgs.forEach((img, i) => img.src = `/img/powerUp${i ? i : ""}.jpg`);

        // Classes
        class GameObject {
            constructor(x, y, speed = 1.5) {
                this.x = x;
                this.y = y;
                this.speed = speed;
                this.width = 30;
                this.height = 30;
                this.direction = {
                    x: (Math.random() * 2 - 1) * speed,
                    y: (Math.random() * 2 - 1) * speed
                };
            }

            moveRandomly(canvas) {
                this.x += this.direction.x;
                this.y += this.direction.y;

                if (this.x <= 0 || this.x >= canvas.width - this.width) {
                    this.direction.x *= -1;
                }
                if (this.y <= 0 || this.y >= canvas.height - this.height) {
                    this.direction.y *= -1;
                }

                if (Math.random() < 0.005) {
                    this.direction.x = (Math.random() * 2 - 1) * this.speed;
                    this.direction.y = (Math.random() * 2 - 1) * this.speed;
                }
            }
        }

        class BonusManager {
            constructor() {
                this.powerUps = [];
                this.lives = [];
            }

            addPowerUp(type) {
                if (this.powerUps.length >= 5) return;

                this.powerUps.push({
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: -50,
                    width: 40,
                    height: 40,
                    speed: 1,
                    type: type !== undefined ? type : Math.floor(Math.random() * 2)
                });
            }

            addLife() {
                if (this.lives.length >= 3) return;

                this.lives.push({
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: -50,
                    width: 40,
                    height: 40,
                    speed: 2
                });
            }

            update() {
                if (gameManager.isPaused) return;

                // Mise à jour des power-ups
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    powerUp.y += powerUp.speed;
                    powerUp.x += Math.sin(Date.now() * 0.002) * 2;
                    powerUp.x = Math.max(0, Math.min(canvas.width - powerUp.width, powerUp.x));

                    if (powerUp.y >= canvas.height) {
                        this.powerUps.splice(i, 1);
                    }
                }

                // Mise à jour des vies
                for (let i = this.lives.length - 1; i >= 0; i--) {
                    const life = this.lives[i];
                    life.y += life.speed;
                    life.x += Math.sin(Date.now() * 0.001) * 1.5;
                    life.x = Math.max(0, Math.min(canvas.width - life.width, life.x));

                    if (life.y >= canvas.height) {
                        this.lives.splice(i, 1);
                    }
                }
            }

            draw(ctx) {
                // Dessin des power-ups
                this.powerUps.forEach(powerUp => {
                    try {
                        ctx.drawImage(
                            powerUpImgs[powerUp.type],
                            powerUp.x, powerUp.y,
                            powerUp.width, powerUp.height
                        );

                        if (Math.random() > 0.7) {
                            ctx.save();
                            ctx.globalAlpha = 0.3;
                            ctx.fillStyle = "#04fbac";
                            ctx.beginPath();
                            ctx.arc(
                                powerUp.x + powerUp.width/2,
                                powerUp.y + powerUp.height/2,
                                powerUp.width/2 + 5,
                                0,
                                Math.PI * 2
                            );
                            ctx.fill();
                            ctx.restore();
                        }
                    } catch (error) {
                        console.error("Erreur lors du dessin d'un power-up:", error);
                    }
                });

                // Dessin des vies
                this.lives.forEach(life => {
                    try {
                        ctx.drawImage(
                            livesImg,
                            life.x, life.y,
                            life.width, life.height
                        );

                        const pulseFactor = Math.sin(Date.now() * 0.005) * 0.2 + 1;

                        ctx.save();
                        ctx.globalAlpha = 0.2;
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(
                            life.x + life.width/2,
                            life.y + life.height/2,
                            life.width/2 * pulseFactor,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                        ctx.restore();
                    } catch (error) {
                        console.error("Erreur lors du dessin d'une vie:", error);
                    }
                });
            }

            checkAllCollisions() {
                this.checkCollisions(
                    starship,
                    type => activatePowerUp(starship, type),
                    () => {
                        starship.lives++;
                        updatePlayerStats();
                        playSound(soundEffects.perfect);
                    }
                );

                if (isMultiplayer && starship2) {
                    this.checkCollisions(
                        starship2,
                        type => activatePowerUp(starship2, type),
                        () => {
                            starship2.lives++;
                            updatePlayerStats();
                            playSound(soundEffects.perfect);
                        }
                    );
                }

                if (isTriplePlayer && starship3) {
                    this.checkCollisions(
                        starship3,
                        type => activatePowerUp(starship3, type),
                        () => {
                            starship3.lives++;
                            updatePlayerStats();
                            playSound(soundEffects.perfect);
                        }
                    );
                }
            }

            checkCollisions(ship, handlePowerUp, handleLife) {
                if (!ship || !ship.isActive) return;

                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    if (checkCollision(ship, powerUp)) {
                        handlePowerUp(powerUp.type);
                        this.powerUps.splice(i, 1);
                    }
                }

                for (let i = this.lives.length - 1; i >= 0; i--) {
                    const life = this.lives[i];
                    if (checkCollision(ship, life)) {
                        handleLife();
                        this.lives.splice(i, 1);
                    }
                }
            }
        }

        class GameManager {
            constructor(canvas) {
                this.canvas = canvas;
                this.isPaused = false;
                this.setupPauseControl();
            }

            setupPauseControl() {
                window.addEventListener("mousedown", (e) => {
                    if (e.button === 1) {
                        e.preventDefault();
                        this.togglePause();
                    }
                });

                window.addEventListener("keydown", (e) => {
                    if (e.code === "Escape") {
                        this.togglePause();
                    }
                });
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                if (this.isPaused) {
                    soundEffects.shoot.pause();
                } else if (shooting && !starship.stunned) {
                    soundEffects.shoot.play();
                }
            }

            draw(ctx) {
                if (this.isPaused) {
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "white";
                    ctx.font = "48px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText("PAUSE", canvas.width / 2, canvas.height / 2);
                }
            }
        }

        // Création des instances
        const gameManager = new GameManager(canvas);
        const bonusManager = new BonusManager();

        // Événements
        window.addEventListener("gamepadconnected", function(e) {
            console.log("Manette connectée à l'indice %d: %s. %d boutons, %d axes.",
                e.gamepad.index, e.gamepad.id,
                e.gamepad.buttons.length, e.gamepad.axes.length);
            gamepadConnected = true;
            gamepadIndex = e.gamepad.index;
        });

        window.addEventListener("gamepaddisconnected", function(e) {
            if (gamepadIndex === e.gamepad.index) {
                gamepadConnected = false;
                gamepadIndex = null;
            }
        });

        // Contrôles clavier
        window.addEventListener("keydown", function(e) {
            if (isMultiplayer) {
                switch(e.code) {
                    case "ArrowUp": keyUp = true; break;
                    case "ArrowDown": keyDown = true; break;
                    case "ArrowLeft": keyLeft = true; break;
                    case "ArrowRight": keyRight = true; break;
                    case "Enter":
                        keySpace = true;
                        shooting2 = true;
                        if (!gameManager.isPaused && starship2) {
                            starship2.bullets.push({
                                x: starship2.x + starship2.width / 2 - 2.5,
                                y: starship2.y,
                                width: 5,
                                height: 10,
                                speed: 20,
                                player: 2
                            });
                        }
                        break;
                }
            }

            if (isTriplePlayer) {
                switch(e.code) {
                    case "KeyW": keyW = true; break;
                    case "KeyS": keyS = true; break;
                    case "KeyA": keyA = true; break;
                    case "KeyD": keyD = true; break;
                    case "KeyE":
                        keyE = true;
                        shooting3 = true;
                        if (!gameManager.isPaused && starship3) {
                            starship3.bullets.push({
                                x: starship3.x + starship3.width / 2 - 2.5,
                                y: starship3.y,
                                width: 5,
                                height: 10,
                                speed: 20,
                                player: 3
                            });
                        }
                        break;
                }
            }
        });

        window.addEventListener("keyup", function(e) {
            if (isMultiplayer) {
                switch(e.code) {
                    case "ArrowUp": keyUp = false; break;
                    case "ArrowDown": keyDown = false; break;
                    case "ArrowLeft": keyLeft = false; break;
                    case "ArrowRight": keyRight = false; break;
                    case "Enter":
                        keySpace = false;
                        shooting2 = false;
                        break;
                }
            }

            if (isTriplePlayer) {
                switch(e.code) {
                    case "KeyW": keyW = false; break;
                    case "KeyS": keyS = false; break;
                    case "KeyA": keyA = false; break;
                    case "KeyD": keyD = false; break;
                    case "KeyE":
                        keyE = false;
                        shooting3 = false;
                        break;
                }
            }
        });

        // Contrôles souris
        window.addEventListener("mousemove", (event) => {
            if (!gameManager.isPaused && !starship.stunned) {
                starship.x = Math.max(
                    0,
                    Math.min(
                        canvas.width - starship.width,
                        event.clientX - starship.width / 2
                    )
                );
                starship.y = Math.max(
                    0,
                    Math.min(
                        canvas.height - starship.height,
                        event.clientY - starship.height / 2 + 20
                    )
                );
            }
        });

        window.addEventListener("mousedown", (e) => {
            if (e.button === 0) {
                shooting = true;
                if (!gameManager.isPaused) {
                    soundEffects.shoot.play().catch(() => {});
                }
            }
        });

        window.addEventListener("mouseup", (e) => {
            if (e.button === 0) {
                shooting = false;
                soundEffects.shoot.pause();
                soundEffects.shoot.currentTime = 0;
            }
        });

        // Fonctions utilitaires
        function playSound(sound) {
            try {
                sound.currentTime = 0;
                sound.play().catch(error => {
                    console.warn("Impossible de jouer le son:", error);
                });
            } catch (error) {
                console.error("Erreur lors de la lecture du son:", error);
            }
        }

        function checkCollision(rect1, rect2) {
            if (!rect1 || !rect2 ||
                typeof rect1.x !== 'number' || typeof rect1.y !== 'number' ||
                typeof rect2.x !== 'number' || typeof rect2.y !== 'number') {
                return false;
            }

            const overlapX = Math.max(0, Math.min(rect1.x + rect1.width, rect2.x + rect2.width) -
                               Math.max(rect1.x, rect2.x));
            const overlapY = Math.max(0, Math.min(rect1.y + rect1.height, rect2.y + rect2.height) -
                               Math.max(rect1.y, rect2.y));

            return overlapX > 0 && overlapY > 0;
        }

        function updatePlayerStats() {
            if (isMultiplayer) {
                document.getElementById("playerStats").style.display = "block";
                document.getElementById("p1Lives").textContent = starship.lives;

                if (starship2) {
                    document.getElementById("p2Lives").textContent = starship2.lives;
                }

                if (isTriplePlayer && starship3) {
                    document.getElementById("p3Lives").textContent = starship3.lives;
                }
            } else {
                document.getElementById("livesCount").textContent = starship.lives;
            }
        }

        function getSelectedShip() {
            const key = isMultiplayer ? 'vaisseauChoisiP1' : 'vaisseauChoisi';
            const vaisseauChoisi = localStorage.getItem(key);

            const vaisseauImages = {
                'Intercepteur': 'starship6.jpg',
                'Croiseur': 'starship1.jpg',
                'Destroyer': 'starship2.jpg',
                'Chasseur': 'starship3.jpg',
                'Éclaireur': 'starship4.jpg',
                'Bombardier': 'starship5.jpg',
                'aéronef': 'starship7.jpg'
            };

            if (vaisseauChoisi && vaisseauImages[vaisseauChoisi]) {
                return `/img/${vaisseauImages[vaisseauChoisi]}`;
            }

            return "/img/starship7.jpg";
        }

        function getSelectedShipP2() {
            const vaisseauChoisi = localStorage.getItem('vaisseauChoisiP2');

            const vaisseauImages = {
                'Intercepteur': 'starship6.jpg',
                'Croiseur': 'starship1.jpg',
                'Destroyer': 'starship2.jpg',
                'Chasseur': 'starship3.jpg',
                'Éclaireur': 'starship4.jpg',
                'Bombardier': 'starship5.jpg',
                'aéronef': 'starship7.jpg'
            };

            if (vaisseauChoisi && vaisseauImages[vaisseauChoisi]) {
                return `/img/${vaisseauImages[vaisseauChoisi]}`;
            }

            return "/img/starship6.jpg";
        }

        function getSelectedShipP3() {
            const vaisseauChoisi = localStorage.getItem('vaisseauChoisiP3');

            const vaisseauImages = {
                'Intercepteur': 'starship6.jpg',
                'Croiseur': 'starship1.jpg',
                'Destroyer': 'starship2.jpg',
                'Chasseur': 'starship3.jpg',
                'Éclaireur': 'starship4.jpg',
                'Bombardier': 'starship5.jpg',
                'aéronef': 'starship7.jpg'
            };

            if (vaisseauChoisi && vaisseauImages[vaisseauChoisi]) {
                return `/img/${vaisseauImages[vaisseauChoisi]}`;
            }

            return "/img/starship5.jpg";
        }

        function checkGameState() {
            if (!gameIsRunning) return;

            const currentTime = Date.now();
            const timeSinceLastKill = currentTime - lastKillTime;

            if (enemies.length > 0 && timeSinceLastKill > 10000 && enemies.length === lastEnemyCount) {
                enemies = enemies.slice(0, Math.max(5, Math.floor(enemies.length / 2)));
                lastKillTime = currentTime;
            }

            if (enemies.length > 40) {
                enemies = enemies.slice(0, 40);
            }
            if (enemyBullets.length > 60) {
                enemyBullets = enemyBullets.slice(0, 60);
            }
            if (redPoints.length > 100) {
                redPoints = redPoints.slice(0, 100);
            }

            lastEnemyCount = enemies.length;
            setTimeout(checkGameState, 5000);
        }

        function updateMultiplayerControls() {
            if (gameManager.isPaused) return;

            if (isMultiplayer && starship2 && !starship2.stunned) {
                if (gamepadConnected) {
                    try {
                        const gamepad = navigator.getGamepads()[gamepadIndex];
                        if (gamepad) {
                            const moveSpeed = 8; // Augmentation de la vitesse
                            const axisX = gamepad.axes[0];
                            const axisY = gamepad.axes[1];

                            if (Math.abs(axisX) > 0.1) {
                                starship2.x += axisX * moveSpeed;
                            }
                            if (Math.abs(axisY) > 0.1) {
                                starship2.y += axisY * moveSpeed;
                            }

                            if (gamepad.buttons[0].pressed && !shooting2) {
                                shooting2 = true;
                                starship2.bullets.push({
                                    x: starship2.x + starship2.width / 2 - 2.5,
                                    y: starship2.y,
                                    width: 5,
                                    height: 10,
                                    speed: 20,
                                    player: 2
                                });
                            } else if (!gamepad.buttons[0].pressed) {
                                shooting2 = false;
                            }
                        }
                    } catch (error) {
                        console.error("Erreur manette:", error);
                    }
                }

                const moveSpeed = 5;
                if (keyUp) starship2.y -= moveSpeed;
                if (keyDown) starship2.y += moveSpeed;
                if (keyLeft) starship2.x -= moveSpeed;
                if (keyRight) starship2.x += moveSpeed;

                starship2.x = Math.max(0, Math.min(canvas.width - starship2.width, starship2.x));
                starship2.y = Math.max(0, Math.min(canvas.height - starship2.height, starship2.y));
            }

            if (isTriplePlayer && starship3 && !starship3.stunned) {
                const moveSpeed = 5;
                if (keyW) starship3.y -= moveSpeed;
                if (keyS) starship3.y += moveSpeed;
                if (keyA) starship3.x -= moveSpeed;
                if (keyD) starship3.x += moveSpeed;

                starship3.x = Math.max(0, Math.min(canvas.width - starship3.width, starship3.x));
                starship3.y = Math.max(0, Math.min(canvas.height - starship3.height, starship3.y));
            }
        }

        function handleKill(playerNumber) {
            lastKillTime = Date.now();
            simultaneousKills++;
            enemiesKilled++;
            killsWithoutDeath++;
            document.getElementById("enemiesKilledCount").innerText = enemiesKilled;
            // Vérifier si on atteint 50 ennemis tués pour faire apparaître le boss
            if (enemiesKilled === 200 && !bossActive) {
                createBoss();
            }

            if (isMultiplayer) {
                switch (playerNumber) {
                    case 1:
                        const p1Kills = parseInt(document.getElementById("p1Kills").textContent) + 1;
                        document.getElementById("p1Kills").textContent = p1Kills;
                        const p1Points = parseInt(document.getElementById("p1Points").textContent) + 10;
                        document.getElementById("p1Points").textContent = p1Points;
                        break;
                    case 2:
                        const p2Kills = parseInt(document.getElementById("p2Kills").textContent) + 1;
                        document.getElementById("p2Kills").textContent = p2Kills;
                        const p2Points = parseInt(document.getElementById("p2Points").textContent) + 10;
                        document.getElementById("p2Points").textContent = p2Points;
                        break;
                    case 3:
                        const p3Kills = parseInt(document.getElementById("p3Kills").textContent) + 1;
                        document.getElementById("p3Kills").textContent = p3Kills;
                        const p3Points = parseInt(document.getElementById("p3Points").textContent) + 10;
                        document.getElementById("p3Points").textContent = p3Points;
                        break;
                }
            }

            if (killsWithoutDeath === 20) {
                playSound(soundEffects.brutal);
            } else if (killsWithoutDeath === 30) {
                playSound(soundEffects.super);
            } else if (killsWithoutDeath === 40) {
                playSound(soundEffects.master);
            } else if (killsWithoutDeath === 60) {
                playSound(soundEffects.awesome);
            }

            if (enemiesKilled % 30 === 0) {
                bonusManager.addPowerUp(2);
                playSound(soundEffects.king);
            } else if (enemiesKilled % powerUpFrequency === 0) {
                if (Math.random() < 0.5) {
                    bonusManager.addPowerUp();
                } else {
                    bonusManager.addLife();
                }
            }

            clearTimeout(killTimer);
            killTimer = setTimeout(() => {
                if (simultaneousKills === 2) {
                    playSound(soundEffects.doubleKill);
                } else if (simultaneousKills >= 3) {
                    playSound(soundEffects.tripleKill);
                }
                simultaneousKills = 0;
            }, 200);
        }

        function activatePowerUp(ship, powerUpType) {
            if (powerUpType === 2) {
                try {
                    gameManager.isPaused = true;
                    videoContainer.style.display = "block";
                    powerUpVideo.currentTime = 0;

                    const playPromise = powerUpVideo.play();
                    if (playPromise) {
                        playPromise.catch(error => {
                            console.error("Erreur vidéo:", error);
                            endPowerUpVideo();
                        });
                    }

                    powerUpVideo.onended = endPowerUpVideo;
                } catch (error) {
                    console.error("Erreur powerup:", error);
                    endPowerUpVideo();
                }
            } else {
                if (ship.powerUpTimeoutId) {
                    clearTimeout(ship.powerUpTimeoutId);
                    ship.powerUpTimeoutId = null;
                }

                ship.powerUpLevel = powerUpType + 1;

                ship.powerUpTimeoutId = setTimeout(() => {
                    if (ship.powerUpLevel === powerUpType + 1) {
                        ship.powerUpLevel = 0;
                    }
                    ship.powerUpTimeoutId = null;
                }, 10000);
            }
        }

        function endPowerUpVideo() {
            videoContainer.style.display = "none";
            gameManager.isPaused = false;
            enemies = [];
            enemyBullets = [];

            starship.powerUpLevel = 3;
            if (isMultiplayer && starship2) starship2.powerUpLevel = 3;
            if (isTriplePlayer && starship3) starship3.powerUpLevel = 3;

            if (powerUpTimeoutId) {
                clearTimeout(powerUpTimeoutId);
            }

            powerUpTimeoutId = setTimeout(() => {
                starship.powerUpLevel = 0;
                if (isMultiplayer && starship2) starship2.powerUpLevel = 0;
                if (isTriplePlayer && starship3) starship3.powerUpLevel = 0;
                powerUpTimeoutId = null;
            }, 10000);
        }

        function stunPlayer(player, duration = 2000) {
            if (!player || !player.isActive) return;
           
            player.stunned = true;
           
            document.querySelectorAll("#stun-effect-player" + player.player).forEach(e => e.remove());
           
            const stunEffect = document.createElement("div");
            stunEffect.style.position = "absolute";
            stunEffect.style.left = player.x + "px";
            stunEffect.style.top = player.y + "px";
            stunEffect.style.width = player.width + "px";
            stunEffect.style.height = player.height + "px";
            stunEffect.style.border = "2px dashed yellow";
            stunEffect.style.borderRadius = "50%";
            stunEffect.style.boxShadow = "0 0 10px yellow";
            stunEffect.style.animation = "pulse 0.5s infinite alternate";
            stunEffect.style.zIndex = "5";
            stunEffect.id = "stun-effect-player" + player.player;
           
            document.body.appendChild(stunEffect);
           
            if (player.stunnedTimeout) {
                clearTimeout(player.stunnedTimeout);
            }
           
            player.stunnedTimeout = setTimeout(() => {
                player.stunned = false;
                document.querySelectorAll("#stun-effect-player" + player.player).forEach(e => e.remove());
            }, duration);
        }

        function activateShield(player, duration = 10000) {
            if (!player || !player.isActive) return;
           
            player.shield = true;
           
            const shieldColors = {
                1: "#04fbac",
                2: "#FF7F50",
                3: "#FFFF50"
            };
           
            const shieldColor = shieldColors[player.player] || "#04fbac";
           
            const oldShield = document.getElementById(`shield-effect-player${player.player}`);
            if (oldShield) oldShield.remove();
           
            const shieldEffect = document.createElement("div");
            shieldEffect.id = `shield-effect-player${player.player}`;
            shieldEffect.className = "shield-effect";
            shieldEffect.style.color = shieldColor;
            shieldEffect.style.left = (player.x - 10) + "px";
            shieldEffect.style.top = (player.y - 10) + "px";
            shieldEffect.style.width = (player.width + 20) + "px";
            shieldEffect.style.height = (player.height + 20) + "px";
           
            document.body.appendChild(shieldEffect);
           
            if (player.shieldTimeout) {
                clearTimeout(player.shieldTimeout);
            }
           
            player.shieldTimeout = setTimeout(() => {
                player.shield = false;
                shieldEffect.remove();
            }, duration);
        }

        function checkPlayerVsPlayerCollisions() {
            if (!isMultiplayer) return;

            const players = [starship];
            if (starship2) players.push(starship2);
            if (starship3) players.push(starship3);

            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    const player1 = players[i];
                    const player2 = players[j];

                    if (!player1.isActive || !player2.isActive) continue;

                    player1.bullets.forEach((bullet, index) => {
                        if (checkCollision(bullet, player2) && !player2.shield) {
                            player1.bullets.splice(index, 1);
                            stunPlayer(player2);
                            playSound(soundEffects.hit);
                        }
                    });

                    player2.bullets.forEach((bullet, index) => {
                        if (checkCollision(bullet, player1) && !player1.shield) {
                            player2.bullets.splice(index, 1);
                            stunPlayer(player1);
                            playSound(soundEffects.hit);
                        }
                    });
                }
            }
        }

        function updateStunEffects() {
            [starship, starship2, starship3].filter(Boolean).forEach(player => {
                if (player.stunned) {
                    const effect = document.getElementById("stun-effect-player" + player.player);
                    if (effect) {
                        effect.style.left = player.x + "px";
                        effect.style.top = player.y + "px";
                    }
                }
               
                if (player.shield) {
                    const shield = document.getElementById("shield-effect-player" + player.player);
                    if (shield) {
                        shield.style.left = (player.x - 10) + "px";
                        shield.style.top = (player.y - 10) + "px";
                    }
                }
            });
        }

        // Fonctions pour le boss
        function createBoss() {
            if (bossActive) return;
           
            bossActive = true;
            bossHealth = 500; // Augmentation de la résistance à 500
           
            document.getElementById("bossHealthBar").style.display = "block";
            document.getElementById("bossHealthFill").style.width = "100%";
           
            boss = {
                x: canvas.width / 2 - 75,
                y: 50,
                width: 150,
                height: 150,
                vx: 2, // Augmentation de la vitesse
                vy: 1.5,
                rotation: 0,
                movePattern: 0,
                moveTimer: 0,
                lastMoveChange: Date.now()
            };
           
            playSound(soundEffects.bossAppear);
            enemies = [];
        }

        function updateBoss() {
            if (!bossActive || !boss || gameManager.isPaused) return;
           
            // Rotation continue
            boss.rotation += 2;
            if (boss.rotation >= 360) boss.rotation = 0;
           
            // Mouvement dynamique
            const currentTime = Date.now();
            if (currentTime - boss.lastMoveChange > 3000) {
                boss.movePattern = Math.floor(Math.random() * 4);
                boss.lastMoveChange = currentTime;
            }
           
            switch(boss.movePattern) {
                case 0: // Mouvement circulaire
                    boss.moveTimer += 0.02;
                    boss.x = canvas.width/2 + Math.cos(boss.moveTimer) * 200;
                    boss.y = canvas.height/4 + Math.sin(boss.moveTimer) * 100;
                    break;
                case 1: // Zigzag
                    boss.x += boss.vx;
                    if (boss.x <= 0 || boss.x + boss.width >= canvas.width) {
                        boss.vx *= -1;
                        boss.y += 50;
                        if (boss.y > canvas.height/2) boss.y = 50;
                    }
                    break;
                case 2: // Mouvement en 8
                    boss.moveTimer += 0.02;
                    boss.x = canvas.width/2 + Math.cos(boss.moveTimer) * 200;
                    boss.y = canvas.height/4 + Math.sin(boss.moveTimer * 2) * 100;
                    break;
                case 3: // Dash aléatoire
                    if (Math.random() < 0.02) {
                        boss.vx = (Math.random() - 0.5) * 8;
                        boss.vy = (Math.random() - 0.5) * 6;
                    }
                    boss.x += boss.vx;
                    boss.y += boss.vy;
                    break;
            }
           
            // Maintenir le boss dans les limites
            boss.x = Math.max(0, Math.min(canvas.width - boss.width, boss.x));
            boss.y = Math.max(0, Math.min(canvas.height/2 - boss.height, boss.y));
           
            // Tirs plus fréquents
            bossShootTimer++;
            if (bossShootTimer >= 30) { // Réduit à 30 frames (deux fois plus rapide)
                shootBossBullets();
                bossShootTimer = 0;
            }
        }

        function drawBoss() {
            if (!bossActive || !boss) return;
           
            ctx.save();
            // Effet de flash si le boss est touché
            if (bossHitEffect) {
                ctx.globalAlpha = 0.7;
            }
           
            // Rotation du boss
            ctx.translate(boss.x + boss.width/2, boss.y + boss.height/2);
            ctx.rotate(boss.rotation * Math.PI / 180);
           
            // Dessin du boss
            if (bossImg.complete) {
                ctx.drawImage(bossImg, -boss.width/2, -boss.height/2, boss.width, boss.height);
            } else {
                // Image de secours si l'image du boss n'est pas chargée
                ctx.fillStyle = "red";
                ctx.fillRect(-boss.width/2, -boss.height/2, boss.width, boss.height);
            }
           
            ctx.restore();
        }

        function shootBossBullets() {
            if (!bossActive || !boss) return;
           
            // Tirer dans 16 directions
            for (let i = 0; i < 16; i++) {
                const angle = (i * 22.5) * Math.PI / 180; // 360/16 = 22.5 degrés
                const speed = 4;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
               
                enemyBullets.push({
                    x: boss.x + boss.width/2,
                    y: boss.y + boss.height/2,
                    width: 12, // Taille uniformisée
                    height: 12,
                    speed: 0,
                    vx: vx,
                    vy: vy,
                    type: 2
                });
            }
           
            playSound(soundEffects.shoot);
        }

        function checkBossCollisions() {
            if (!bossActive || !boss) return;
           
            // Vérifier les collisions avec les balles des joueurs
            const checkPlayerBullets = (player) => {
                if (!player || !player.isActive) return;
               
                for (let i = player.bullets.length - 1; i >= 0; i--) {
                    const bullet = player.bullets[i];
                   
                    // Rectangle de collision pour le boss (sans tenir compte de la rotation)
                    const bossRect = {
                        x: boss.x,
                        y: boss.y,
                        width: boss.width,
                        height: boss.height
                    };
                   
                    if (checkCollision(bullet, bossRect)) {
                        // Supprimer la balle
                        player.bullets.splice(i, 1);
                       
                        // Effet de hit
                        bossHitEffect = true;
                        bossHitEffectTimer = 0;
                       
                        // Diminuer la vie du boss
                        bossHealth--;
                       
                        // Mettre à jour la barre de vie
                        document.getElementById("bossHealthFill").style.width = (bossHealth / 500 * 100) + "%";
                       
                        playSound(soundEffects.bossHit);
                       
                        // Vérifier si le boss est détruit
                        if (bossHealth <= 0) {
                            defeatBoss();
                        }
                    }
                }
            };
           
            checkPlayerBullets(starship);
            if (isMultiplayer && starship2) checkPlayerBullets(starship2);
            if (isTriplePlayer && starship3) checkPlayerBullets(starship3);
           
            // Vérifier les collisions entre le boss et les joueurs
            const checkPlayerCollision = (player) => {
                if (!player || !player.isActive) return;
               
                // Rectangle de collision pour le boss
                const bossRect = {
                    x: boss.x,
                    y: boss.y,
                    width: boss.width,
                    height: boss.height
                };
               
                if (checkCollision(player, bossRect)) {
                    if (!player.shield) {
                        player.lives--;
                        updatePlayerStats();
                       
                        if (player.lives <= 0) {
                            playerDeath(player);
                        }
                    }
                }
            };
           
            checkPlayerCollision(starship);
            if (isMultiplayer && starship2) checkPlayerCollision(starship2);
            if (isTriplePlayer && starship3) checkPlayerCollision(starship3);
        }

        function defeatBoss() {
            // Jouer un son
            playSound(soundEffects.bossDeath);
           
            // Créer un effet d'explosion
            for (let i = 0; i < 100; i++) {
                redPoints.push({
                    x: boss.x + Math.random() * boss.width,
                    y: boss.y + Math.random() * boss.height
                });
            }
           
            // Désactiver le boss
            bossActive = false;
            boss = null;
           
            // Cacher la barre de vie
            document.getElementById("bossHealthBar").style.display = "none";
           
            // Activer le fond d'écran défilant
            backgroundActive = true;
            document.getElementById("scrollingBackground").style.display = "block";
           
            // Donner un bonus de points
            enemiesKilled += 10;
            document.getElementById("enemiesKilledCount").innerText = enemiesKilled;
           
            // Bonus pour tous les joueurs actifs
            if (isMultiplayer) {
                const p1Points = parseInt(document.getElementById("p1Points").textContent) + 100;
                document.getElementById("p1Points").textContent = p1Points;
               
                if (starship2 && starship2.isActive) {
                    const p2Points = parseInt(document.getElementById("p2Points").textContent) + 100;
                    document.getElementById("p2Points").textContent = p2Points;
                }
               
                if (isTriplePlayer && starship3 && starship3.isActive) {
                    const p3Points = parseInt(document.getElementById("p3Points").textContent) + 100;
                    document.getElementById("p3Points").textContent = p3Points;
                }
            }
           
            // Ajouter quelques power-ups
            bonusManager.addPowerUp(2);
            bonusManager.addLife();
        }

        function shootBullet() {
            if (gameManager.isPaused) return;

            [
                { ship: starship, isShooting: shooting },
                { ship: starship2, isShooting: shooting2 },
                { ship: starship3, isShooting: shooting3 }
            ].filter(({ ship }) => ship && ship.isActive).forEach(({ ship, isShooting }) => {
                if (!isShooting) return;

                switch (ship.powerUpLevel) {
                    case 0:
                        ship.bullets.push({
                            x: ship.x + ship.width / 2 - 2.5,
                            y: ship.y,
                            width: 5,
                            height: 10,
                            speed: 20,
                            player: ship.player
                        });
                        break;
                    case 1:
                        [-15, -2.5, 10].forEach(xOffset => {
                            ship.bullets.push({
                                x: ship.x + ship.width / 2 + xOffset,
                                y: ship.y,
                                width: 10,
                                height: 15,
                                speed: 10,
                                player: ship.player
                            });
                        });
                        break;
                    case 2:
                    case 3:
                        [
                            { vx: 0, vy: -5 },
                            { vx: 5, vy: -5 },
                            { vx: -5, vy: -5 },
                            { vx: 5, vy: 0 },
                            { vx: -5, vy: 0 }
                        ].forEach(config => {
                            ship.bullets.push({
                                x: ship.x + ship.width / 2 - 5,
                                y: ship.y,
                                width: 10,
                                height: 15,
                                speed: 10,
                                vx: config.vx,
                                vy: config.vy,
                                player: ship.player
                            });
                        });
                        break;
                }

                if (ship.bullets.length > 100) {
                    ship.bullets = ship.bullets.slice(-100);
                }
            });
        }

        function shootEnemyBullets() {
            if (gameManager.isPaused) return;

            const maxNewBullets = 10;
            let newBullets = 0;

            for (let i = 0; i < enemies.length && newBullets < maxNewBullets; i++) {
                const enemy = enemies[i];

                if (Math.random() > 0.2) continue;

                if (enemy.type === 1) {
                    enemyBullets.push(
                        {
                            x: enemy.x,
                            y: enemy.y + enemy.height / 2,
                            width: 10,
                            height: 15,
                            speed: 0,
                            vx: -3 * enemyBulletSpeedMultiplier,
                            type: 1
                        },
                        {
                            x: enemy.x + enemy.width,
                            y: enemy.y + enemy.height / 2,
                            width: 10,
                            height: 15,
                            speed: 0,
                            vx: 3 * enemyBulletSpeedMultiplier,
                            type: 1
                        }
                    );
                } else {
                    enemyBullets.push({
                        x: enemy.x + enemy.width / 2 - 2.5,
                        y: enemy.y + enemy.height,
                        width: 10,
                        height: 15,
                        speed: 3 * enemyBulletSpeedMultiplier,
                        type: Math.floor(Math.random() * 3)
                    });
                }

                newBullets++;
            }

            if (enemyBullets.length > 100) {
                enemyBullets = enemyBullets.slice(-100);
            }
        }

        function generateEnemies() {
            if (gameManager.isPaused) return;

            if (enemies.length > 30) {
                return;
            }

            const count = Math.min(7, 30 - enemies.length);

            for (let i = 0; i < count; i++) {
                enemies.push({
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: Math.random() * (canvas.height / 3),
                    width: 50,
                    height: 50,
                    vx: (Math.random() * 2 - 1) * 2,
                    vy: Math.random() * 1.5,
                    type: Math.floor(Math.random() * 6)
                });
            }
        }

        function drawStarship() {
    const drawPlayer = (player, img) => {
        if (!player || !player.isActive) return;

        if (img && img.complete && img.naturalWidth > 0) {
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
           
            // Rotation uniquement pour le joueur 1
            if (player === starship) {
                if (player.x !== lastShipX) {
                    const moveDirection = player.x - lastShipX;
                    if (moveDirection < 0) {
                        shipRotation = Math.max(-maxRotation, shipRotation - rotationSpeed);
                    } else if (moveDirection > 0) {
                        shipRotation = Math.min(maxRotation, shipRotation + rotationSpeed);
                    }
                    lastShipX = player.x;
                } else {
                    if (shipRotation > 0) {
                        shipRotation = Math.max(0, shipRotation - rotationSpeed/2);
                    } else if (shipRotation < 0) {
                        shipRotation = Math.min(0, shipRotation + rotationSpeed/2);
                    }
                }
                ctx.rotate(shipRotation * Math.PI / 180);
            }
           
            ctx.drawImage(
                img,
                -player.width/2,
                -player.height/2,
                player.width,
                player.height
            );
            ctx.restore();
        } else {
            const colors = {
                1: "#04fbac",
                2: "#FF7F50",
                3: "#FFFF50"
            };
            ctx.fillStyle = colors[player.player];
            ctx.fillRect(player.x, player.y, player.width, player.height);
        }
    };

    drawPlayer(starship, starshipImg);
    if (isMultiplayer) drawPlayer(starship2, starship2Img);
    if (isTriplePlayer) drawPlayer(starship3, starship3Img);
}

        function drawBullets() {
            const drawPlayerBullets = (player) => {
                if (!player || !player.isActive) return;

                player.bullets = player.bullets.filter(bullet => {
                    const isOnScreen = bullet.y > -20 && bullet.y < canvas.height + 20 &&
                                     bullet.x > -20 && bullet.x < canvas.width + 20;

                    if (isOnScreen) {
                        ctx.save();
                        ctx.globalAlpha = player.player === 1 ? 1 : 0.9;
                        ctx.drawImage(bulletImg, bullet.x, bullet.y, bullet.width, bullet.height);
                        ctx.restore();

                        if (bullet.vx !== undefined && bullet.vy !== undefined) {
                            bullet.x += bullet.vx;
                            bullet.y += bullet.vy;
                        } else {
                            bullet.y -= bullet.speed;
                        }
                    }

                    return isOnScreen;
                });
            };

            drawPlayerBullets(starship);
            if (isMultiplayer) drawPlayerBullets(starship2);
            if (isTriplePlayer) drawPlayerBullets(starship3);
        }

        function drawEnemies() {
            enemies = enemies.filter(enemy => {
                try {
                    ctx.drawImage(enemyImgs[enemy.type], enemy.x, enemy.y, enemy.width, enemy.height);

                    enemy.x += enemy.vx;
                    enemy.y += enemy.vy;

                    if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
                        enemy.vx *= -1;
                    }
                    if (enemy.y <= 0) {
                        enemy.vy *= -1;
                    }

                    return enemy.y < canvas.height;
                } catch (error) {
                    console.error("Erreur lors du dessin d'un ennemi:", error);
                    return false;
                }
            });
        }

        function drawEnemyBullets() {
            enemyBullets = enemyBullets.filter(bullet => {
                try {
                    ctx.drawImage(enemyBulletImgs[bullet.type], bullet.x, bullet.y, bullet.width, bullet.height);

                    if (bullet.vx) {
                        bullet.x += bullet.vx;
                    } else {
                        bullet.y += bullet.speed;
                    }

                    return bullet.y < canvas.height && bullet.x > 0 && bullet.x < canvas.width;
                } catch (error) {
                    console.error("Erreur lors du dessin d'une balle ennemie:", error);
                    return false;
                }
            });
        }

        function drawRedPoints() {
    if (redPoints.length > 500) {
        redPoints = redPoints.slice(0, 500);
    }
    
    // Nouvelle approche qui évite les boucles infinies
    redPoints = redPoints.filter((point) => {
        ctx.fillStyle = "red";
        ctx.fillRect(point.x, point.y, 2, 2);
        point.y += 1;
        
        let attractedToPlayer = false;
        let minDistance = Number.MAX_VALUE;
        let attraction = { x: 0, y: 0 };
        
        // Vérifier attraction au joueur 1
        if (starship && starship.isActive) {
            const dx = starship.x + starship.width/2 - point.x;
            const dy = starship.y + starship.height/2 - point.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 100 && distance < minDistance) {
                attraction.x = dx / distance * 3;
                attraction.y = dy / distance * 3;
                minDistance = distance;
                attractedToPlayer = true;
                
                if (distance < 30) {
                    coins += 0.5;
                    document.getElementById("coinsCount").textContent = coins.toFixed(1);
                    playSound(soundEffects.coin);
                    starship.redPointsCollected++;
                    
                    if (starship.redPointsCollected >= 200) {
                        activateShield(starship);
                        starship.redPointsCollected = 0;
                    }
                    
                    return false; // supprime ce point
                }
            }
        }
        
        // Vérifier attraction au joueur 2
        if (isMultiplayer && starship2 && starship2.isActive) {
            const dx = starship2.x + starship2.width/2 - point.x;
            const dy = starship2.y + starship2.height/2 - point.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 100 && distance < minDistance) {
                attraction.x = dx / distance * 3;
                attraction.y = dy / distance * 3;
                minDistance = distance;
                attractedToPlayer = true;
                
                if (distance < 30) {
                    coins += 0.5;
                    document.getElementById("coinsCount").textContent = coins.toFixed(1);
                    playSound(soundEffects.coin);
                    starship2.redPointsCollected++;
                    
                    if (starship2.redPointsCollected >= 200) {
                        activateShield(starship2);
                        starship2.redPointsCollected = 0;
                    }
                    
                    return false; // supprime ce point
                }
            }
        }
        
        // Vérifier attraction au joueur 3
        if (isTriplePlayer && starship3 && starship3.isActive) {
            const dx = starship3.x + starship3.width/2 - point.x;
            const dy = starship3.y + starship3.height/2 - point.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 100 && distance < minDistance) {
                attraction.x = dx / distance * 3;
                attraction.y = dy / distance * 3;
                minDistance = distance;
                attractedToPlayer = true;
                
                if (distance < 30) {
                    coins += 0.5;
                    document.getElementById("coinsCount").textContent = coins.toFixed(1);
                    playSound(soundEffects.coin);
                    starship3.redPointsCollected++;
                    
                    if (starship3.redPointsCollected >= 200) {
                        activateShield(starship3);
                        starship3.redPointsCollected = 0;
                    }
                    
                    return false; // supprime ce point
                }
            }
        }
        
        // Appliquer l'attraction si nécessaire
        if (attractedToPlayer) {
            point.x += attraction.x;
            point.y += attraction.y;
        }
        
        // Conserver le point s'il est toujours dans l'écran
        return point.y <= canvas.height;
    });
}

        function checkCollisions() {
            if (!gameIsRunning || gameManager.isPaused) return;

            if (enemies.length > 40) enemies = enemies.slice(0, 40);
            if (enemyBullets.length > 60) enemyBullets = enemyBullets.slice(0, 60);

            const checkPlayerCollisions = (player, playerNumber) => {
                if (!player || !player.isActive) return;

                // Collisions balles-ennemis
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    let enemyHit = false;

                    for (let j = player.bullets.length - 1; j >= 0; j--) {
                        const bullet = player.bullets[j];
                        if (!bullet || !enemy) continue;

                        if (checkCollision(bullet, enemy)) {
                            playSound(soundEffects.hit);
                            player.bullets.splice(j, 1);
                            enemyHit = true;

                            for (let k = 0; k < 15; k++) {
                                redPoints.push({
                                    x: enemy.x + Math.random() * enemy.width,
                                    y: enemy.y + Math.random() * enemy.height
                                });
                            }

                            handleKill(playerNumber);
                            break;
                        }
                    }

                    if (enemyHit) {
                        enemies.splice(i, 1);
                        continue;
                    }

                    if (checkCollision(player, enemy)) {
                        playSound(soundEffects.hit);
                        if (!player.shield) {
                            player.lives--;
                            updatePlayerStats();
                        }
                        enemies.splice(i, 1);

                        if (player.lives <= 0) {
                            playerDeath(player);
                        }
                    }
                }

                // Collisions avec les balles ennemies
                for (let i = enemyBullets.length - 1; i >= 0; i--) {
                    const bullet = enemyBullets[i];
                    if (checkCollision(player, bullet)) {
                        playSound(soundEffects.hit);
                        enemyBullets.splice(i, 1);

                        if (!player.shield) {
                            player.lives--;
                            killsWithoutDeath = 0;
                            updatePlayerStats();
                            if (player.lives <= 0) {
                                playerDeath(player);
                            }
                        }
                    }
                }
            };

            checkPlayerCollisions(starship, 1);
            if (isMultiplayer && starship2) checkPlayerCollisions(starship2, 2);
            if (isTriplePlayer && starship3) checkPlayerCollisions(starship3, 3);

            bonusManager.checkAllCollisions();
            if (isMultiplayer) checkPlayerVsPlayerCollisions();
        }

        function playerDeath(player) {
            player.isActive = false;

            let allPlayersDead = !starship.isActive;
            if (isMultiplayer) allPlayersDead = allPlayersDead && !starship2.isActive;
            if (isTriplePlayer) allPlayersDead = allPlayersDead && !starship3.isActive;

            if (allPlayersDead) {
                gameOver();
            } else {
                const playerMessage = document.createElement("div");
                playerMessage.style.position = "absolute";
                playerMessage.style.color = player.player === 1 ? "#04fbac" :
                                          player.player === 2 ? "#FF7F50" : "#FFFF50";
                playerMessage.style.fontSize = "24px";
                playerMessage.style.fontWeight = "bold";
                playerMessage.style.padding = "10px";
                playerMessage.style.borderRadius = "5px";
                playerMessage.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
                playerMessage.style.left = "50%";
                playerMessage.style.transform = "translateX(-50%)";
                playerMessage.style.zIndex = "100";
                playerMessage.style.top = (30 + (player.player - 1) * 10) + "%";
                playerMessage.textContent = `Joueur ${player.player} T'ES MORT !`;

                document.body.appendChild(playerMessage);

                setTimeout(() => {
                    document.body.removeChild(playerMessage);
                }, 2000);
            }
        }

        function gameOver() {
            document.querySelectorAll("[id^='stun-effect-player'], [id^='shield-effect-player']").forEach(e => e.remove());
            Object.values(soundEffects).forEach(sound => {
                sound.pause();
                sound.currentTime = 0;
            });

            const gameOverContainer = document.getElementById("gameOverContainer");
            const gameOverMessage = document.getElementById("gameOverMessage");
            const continueCounter = document.getElementById("continueCounter");

            gameOverContainer.style.display = "block";
            gameManager.isPaused = true;

            let countdown = 5;
            continueCounter.textContent = countdown;

            const countInterval = setInterval(() => {
                countdown--;
                continueCounter.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countInterval);
                    continueCounter.style.display = "none";
                    gameOverMessage.style.display = "block";

                    setTimeout(() => {
                        gameOverContainer.style.display = "none";
                        gameOverMessage.style.display = "none";
                        continueCounter.style.display = "block";
                        gameManager.isPaused = false;

                        // Réinitialisation
                        enemies = [];
                        enemyBullets = [];
                        redPoints = [];
                        enemiesKilled = 0;
                        simultaneousKills = 0;
                        killsWithoutDeath = 0;
                        coins = 0;

                        [starship, starship2, starship3].filter(Boolean).forEach(player => {
                            player.bullets = [];
                            player.powerUpLevel = 0;
                            player.lives = 3;
                            player.isActive = true;
                        });

                        if (isMultiplayer) {
                            document.getElementById("p1Points").textContent = "0";
                            document.getElementById("p1Kills").textContent = "0";
                            if (starship2) {
                                document.getElementById("p2Points").textContent = "0";
                                document.getElementById("p2Kills").textContent = "0";
                            }
                            if (isTriplePlayer && starship3) {
                                document.getElementById("p3Points").textContent = "0";
                                document.getElementById("p3Kills").textContent = "0";
                            }
                        }

                        document.getElementById("livesCount").innerText = playerLives;
                        document.getElementById("enemiesKilledCount").innerText = enemiesKilled;
                        document.getElementById("coinsCount").textContent = coins.toFixed(1);

                        starship.x = canvas.width / 2;
                        starship.y = canvas.height - 50;
                        if (isMultiplayer && starship2) {
                            starship2.x = canvas.width / 2 + 100;
                            starship2.y = canvas.height - 50;
                        }
                        if (isTriplePlayer && starship3) {
                            starship3.x = canvas.width / 2 - 100;
                            starship3.y = canvas.height - 50;
                        }

                        if (enemiesKilled < 5) {
                            playSound(soundEffects.humiliation);
                        }
                    }, 2000);
                }
            }, 1000);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function update(timestamp) {
    if (!gameIsRunning) return;
    
    // Protection contre les boucles infinies
    if (window.frameCount === undefined) {
        window.frameCount = 0;
    }
    window.frameCount++;
    
    if (window.frameCount > 10000) {
        console.error("Possible boucle infinie détectée, réinitialisation du jeu");
        window.frameCount = 0;
        gameIsRunning = false;
        setTimeout(() => {
            gameIsRunning = true;
            lastFrameTime = 0;
            requestAnimationFrame(update);
        }, 1000);
        return;
    }

            if (!lastFrameTime) lastFrameTime = timestamp;
            deltaTime = timestamp - lastFrameTime;

            if (deltaTime < frameDuration) {
                requestAnimationFrame(update);
                return;
            }

            fpsCounter++;
            fpsTimer += deltaTime;
            if (fpsTimer >= 1000) {
                fpsCounter = 0;
                fpsTimer = 0;
            }

            lastFrameTime = timestamp;

            if (gameManager.isPaused) {
                gameManager.draw(ctx);
                requestAnimationFrame(update);
                return;
            }

            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (isMultiplayer) {
                    updateMultiplayerControls();
                }

                drawStarship();
                updateStunEffects();
                drawBullets();
                drawEnemies();
                drawEnemyBullets();
                drawRedPoints();

                if (bossActive) {
                    updateBoss();
                    drawBoss();
                    checkBossCollisions();
                }

                bonusManager.update();
                bonusManager.draw(ctx);

                gameManager.draw(ctx);

                checkCollisions();
                if (isMultiplayer) {
                    checkPlayerVsPlayerCollisions();
                }

            } catch (error) {
                console.error("Erreur dans la boucle de jeu:", error);
            }

            const currentTime = Date.now();
            const frameDelta = currentTime - (window.lastFrameTime || currentTime);
            window.lastFrameTime = currentTime;

            if (frameDelta > 100) {
                if (frameDelta > 300) {
                    if (enemies.length > 15) enemies = enemies.slice(0, 15);
                    if (enemyBullets.length > 20) enemyBullets = enemyBullets.slice(0, 20);
                    if (redPoints.length > 50) redPoints = redPoints.slice(0, 50);
                }
            }

            requestAnimationFrame(update);
        }

        // Initialisation
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // Chargement des ressources
        Promise.all([
            ...enemyImgs,
            ...enemyBulletImgs,
            ...powerUpImgs,
            starshipImg,
            bulletImg,
            livesImg,
            ...(isMultiplayer ? [starship2Img] : []),
            ...(isTriplePlayer ? [starship3Img] : [])
        ].filter(Boolean).map(img => new Promise(resolve => {
            if (img.complete) {
                resolve();
            } else {
                img.onload = resolve;
                img.onerror = () => {
                    console.error("Erreur de chargement pour:", img.src);
                    resolve();
                };
            }
        })))
        .then(() => {
            try {
                updatePlayerStats();
                checkGameState();
                requestAnimationFrame(update);

                const intervals = [
                    setInterval(shootBullet, 100),
                    setInterval(generateEnemies, 5000),
                    setInterval(shootEnemyBullets, 1000),
                    setInterval(() => {
                        if (!gameManager.isPaused) {
                            const specialEnemies = enemies.filter(e => e.type === 1).slice(0, 3);
                            specialEnemies.forEach(() => shootEnemyBullets());
                        }
                    }, 500)
                ];

                window.addEventListener("beforeunload", () => {
                    intervals.forEach(clearInterval);
                });

            } catch (error) {
                console.error("Erreur au démarrage du jeu:", error);
            }
        })
        .catch(error => {
            console.error("Erreur lors du chargement des ressources:", error);
        });
    </script>
</body>
</html>